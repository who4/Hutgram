<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .subtitle {
      color: #8e8e8e;
      font-size: 14px;
    }

    .links {
      margin-top: 15px;
    }

    .links a {
      color: #0095f6;
      text-decoration: none;
      margin-right: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #0095f6;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: #262626;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #dbdbdb;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }

    select:disabled {
      background: #f5f5f5;
      color: #8e8e8e;
      cursor: not-allowed;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    button {
      background: #0095f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      background: #1877f2;
    }

    button:active {
      transform: scale(0.98);
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .message {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .hidden {
      display: none;
    }

    .helper-text {
      font-size: 12px;
      color: #8e8e8e;
      margin-top: 5px;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dbdbdb;
    }

    th {
      background: #fafafa;
      font-weight: 600;
      color: #262626;
      font-size: 14px;
    }

    td {
      font-size: 14px;
      color: #262626;
    }

    tr:hover {
      background: #fafafa;
    }

    .code {
      font-family: 'Courier New', monospace;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
    }

    .delete-btn {
      background: #ed4956;
      padding: 6px 12px;
      font-size: 12px;
      width: auto;
      margin: 0;
    }

    .delete-btn:hover {
      background: #c13584;
    }

    /* Grid layouts for data */
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .user-card, .post-card-admin {
      background: #fafafa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dbdbdb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-info {
      flex: 1;
      min-width: 0;
    }

    .item-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .item-subtitle {
      color: #8e8e8e;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üõ†Ô∏è Admin Dashboard</h1>
      <p class="subtitle">Manage users, posts, and relationships</p>
      <div class="links">
        <a href="/">‚Üê Back to App</a>
      </div>
    </header>

    <!-- CREATE SECTION -->
    <div class="grid">
      <!-- Create User -->
      <div class="card">
        <h2>Create User</h2>
        <div id="createUserMessage" class="message hidden"></div>
        <form id="createUserForm">
          <div class="form-group">
            <label>Username*</label>
            <input type="text" id="newUsername" required placeholder="johndoe">
          </div>
          <div class="form-group">
            <label>Full Name*</label>
            <input type="text" id="newName" required placeholder="John Doe">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea id="newBio" placeholder="Tell us about yourself..."></textarea>
          </div>
          <div class="form-group">
            <label>Avatar URL</label>
            <input type="url" id="newAvatar" placeholder="https://example.com/avatar.jpg">
          </div>
          <div class="form-group">
            <label>Categories (Interests)</label>
            <div id="userCategoryGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px;"></div>
          </div>
          <button type="submit">Create User</button>
        </form>
      </div>

      <!-- Create Post -->
      <div class="card">
        <h2>Create Post</h2>
        <div id="createPostMessage" class="message hidden"></div>
        <form id="createPostForm">
          <div class="form-group">
            <label>Post Type*</label>
            <select id="postType" required>
              <option value="user">User Post</option>
              <option value="explore">Explore Post (No User)</option>
            </select>
          </div>
          <div class="form-group" id="userSelectGroup">
            <label>User*</label>
            <select id="postUsername">
              <option value="">Select user...</option>
            </select>
          </div>
          <div class="form-group hidden" id="authorGroup">
            <label>Author Name*</label>
            <input type="text" id="postAuthor" placeholder="travel_guru">
            <div class="helper-text">Fake author name for explore post</div>
          </div>
          <div class="form-group">
            <label>Caption*</label>
            <textarea id="postCaption" required placeholder="Write a caption..."></textarea>
          </div>
          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="postImage" placeholder="https://example.com/image.jpg">
          </div>
          <div class="form-group">
            <label>Categories</label>
            <div id="postCategoryGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px;"></div>
          </div>
          <button type="submit">Create Post</button>
        </form>
      </div>

      <!-- Create Follow -->
      <div class="card">
        <h2>Create Follow</h2>
        <div id="followMessage" class="message hidden"></div>
        <form id="followForm">
          <div class="form-group">
            <label>Follower*</label>
            <select id="follower" required>
              <option value="">Select user...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Following*</label>
            <select id="following" required>
              <option value="">Select user...</option>
            </select>
          </div>
          <button type="submit">Create Follow</button>
        </form>
      </div>

      <!-- Create Like -->
      <div class="card">
        <h2>Create Like</h2>
        <div id="likeMessage" class="message hidden"></div>
        <form id="likeForm">
          <div class="form-group">
            <label>User*</label>
            <select id="likeUsername" required>
              <option value="">Select user...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Post*</label>
            <select id="likePostSelect" required disabled>
              <option value="">First select a user...</option>
            </select>
            <div class="helper-text">Select a user first to see available posts</div>
          </div>
          <button type="submit">Create Like</button>
        </form>
      </div>
    </div>

    <!-- VIEW SECTION -->
    <!-- All Users -->
    <div class="card full-width">
      <h2>All Users</h2>
      <div class="users-grid" id="usersGrid">
        <div style="grid-column: 1/-1; text-align: center; color: #8e8e8e; padding: 20px;">Loading...</div>
      </div>
    </div>

    <!-- All Posts -->
    <div class="card full-width">
      <h2>All Posts</h2>
      <div class="users-grid" id="postsGrid">
        <div style="grid-column: 1/-1; text-align: center; color: #8e8e8e; padding: 20px;">Loading...</div>
      </div>
    </div>

    <!-- Follow Relationships -->
    <div class="card full-width">
      <h2>Follow Relationships (User ‚Üí User)</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Follower</th>
              <th>Following</th>
            </tr>
          </thead>
          <tbody id="followsTable">
            <tr><td colspan="2" style="text-align: center; color: #8e8e8e;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Like Relationships -->
    <div class="card full-width">
      <h2>Like Relationships (User ‚Üí Post)</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Post ID</th>
              <th>Post Caption</th>
            </tr>
          </thead>
          <tbody id="likesTable">
            <tr><td colspan="3" style="text-align: center; color: #8e8e8e;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let userSelectedCategories = [];
    let postSelectedCategories = [];
    let CATEGORIES = [];

    // ==================== LOAD DATA ====================
    
    async function loadCategories() {
      try {
        const res = await fetch("/api/categories");
        CATEGORIES = await res.json();
        
        // Populate user category grid
        const userGrid = document.getElementById("userCategoryGrid");
        userGrid.innerHTML = CATEGORIES.map(cat => `
          <div onclick="toggleUserCategory('${cat}')" style="padding: 5px 10px; border: 1px solid #dbdbdb; border-radius: 15px; font-size: 12px; text-align: center; cursor: pointer;" class="cat-chip-user">${cat}</div>
        `).join("");
        
        // Populate post category grid
        const postGrid = document.getElementById("postCategoryGrid");
        postGrid.innerHTML = CATEGORIES.map(cat => `
          <div onclick="togglePostCategory('${cat}')" style="padding: 5px 10px; border: 1px solid #dbdbdb; border-radius: 15px; font-size: 12px; text-align: center; cursor: pointer;" class="cat-chip-post">${cat}</div>
        `).join("");
      } catch (error) {
        console.error("Error loading categories:", error);
      }
    }
    
    function toggleUserCategory(cat) {
      const chips = document.querySelectorAll('.cat-chip-user');
      chips.forEach(chip => {
        if (chip.textContent === cat) {
          chip.style.background = chip.style.background === 'rgb(0, 149, 246)' ? '' : '#0095f6';
          chip.style.color = chip.style.background ? 'white' : '#262626';
        }
      });
      
      if (userSelectedCategories.includes(cat)) {
        userSelectedCategories = userSelectedCategories.filter(c => c !== cat);
      } else {
        userSelectedCategories.push(cat);
      }
    }
    
    function togglePostCategory(cat) {
      const chips = document.querySelectorAll('.cat-chip-post');
      chips.forEach(chip => {
        if (chip.textContent === cat) {
          chip.style.background = chip.style.background === 'rgb(0, 149, 246)' ? '' : '#0095f6';
          chip.style.color = chip.style.background ? 'white' : '#262626';
        }
      });
      
      if (postSelectedCategories.includes(cat)) {
        postSelectedCategories = postSelectedCategories.filter(c => c !== cat);
      } else {
        postSelectedCategories.push(cat);
      }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch("/api/users");
        const users = await res.json();

        // Populate all user dropdowns
        const selects = ["postUsername", "follower", "following", "likeUsername"];
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">Select user...</option>';
          users.forEach(u => {
            const opt = document.createElement("option");
            opt.value = u.username;
            opt.textContent = `${u.name} (@${u.username})`;
            select.appendChild(opt);
          });
        });

        displayUsers(users);
      } catch (error) {
        console.error("Error loading users:", error);
      }
    }

    function displayUsers(users) {
      const grid = document.getElementById("usersGrid");
      if (users.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #8e8e8e; padding: 20px;">No users yet</div>';
        return;
      }

      grid.innerHTML = users.map(user => `
        <div class="user-card">
          <div class="item-info">
            <div class="item-title">@${user.username}</div>
            <div class="item-subtitle">${user.name}</div>
          </div>
          <button class="delete-btn" onclick="deleteUser('${user.username}')">Delete</button>
        </div>
      `).join("");
    }

    async function loadPosts() {
      try {
        const res = await fetch("/api/admin/posts");
        const posts = await res.json();
        const grid = document.getElementById("postsGrid");

        if (posts.length === 0) {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #8e8e8e; padding: 20px;">No posts yet</div>';
          return;
        }

        grid.innerHTML = posts.map(post => `
          <div class="post-card-admin">
            <div class="item-info">
              <div class="item-title">${post.username ? `@${post.username}` : `@${post.exploreAuthor}`}</div>
              <div class="item-subtitle">${post.caption.substring(0, 50)}${post.caption.length > 50 ? '...' : ''}</div>
              <div class="item-subtitle"><span class="code">${post.id}</span></div>
            </div>
            <button class="delete-btn" onclick="deletePost('${post.id}')">Delete</button>
          </div>
        `).join("");
      } catch (error) {
        console.error("Error loading posts:", error);
      }
    }

    async function loadFollows() {
      try {
        const res = await fetch("/api/admin/follows");
        const follows = await res.json();
        const tbody = document.getElementById("followsTable");

        if (follows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #8e8e8e;">No follow relationships yet</td></tr>';
          return;
        }

        tbody.innerHTML = follows.map(follow => `
          <tr>
            <td><strong>@${follow.follower}</strong> (${follow.followerName})</td>
            <td><strong>@${follow.following}</strong> (${follow.followingName})</td>
          </tr>
        `).join("");
      } catch (error) {
        console.error("Error loading follows:", error);
      }
    }

    async function loadLikes() {
      try {
        const res = await fetch("/api/admin/likes");
        const likes = await res.json();
        const tbody = document.getElementById("likesTable");

        if (likes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #8e8e8e;">No like relationships yet</td></tr>';
          return;
        }

        tbody.innerHTML = likes.map(like => `
          <tr>
            <td><strong>@${like.username}</strong> (${like.name})</td>
            <td><span class="code">${like.postId}</span></td>
            <td>${like.caption.substring(0, 40)}${like.caption.length > 40 ? '...' : ''}</td>
          </tr>
        `).join("");
      } catch (error) {
        console.error("Error loading likes:", error);
      }
    }

    // ==================== HELPER FUNCTIONS ====================

    function showMessage(elementId, message, isSuccess) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message ${isSuccess ? 'success' : 'error'}`;
      setTimeout(() => {
        el.className = 'message hidden';
      }, 3000);
    }

    // ==================== CREATE HANDLERS ====================

    document.getElementById("createUserForm").onsubmit = async (e) => {
      e.preventDefault();
      try {
        const res = await fetch("/api/admin/user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: document.getElementById("newUsername").value,
            name: document.getElementById("newName").value,
            bio: document.getElementById("newBio").value,
            avatar: document.getElementById("newAvatar").value,
            categories: userSelectedCategories
          })
        });

        if (res.ok) {
          showMessage("createUserMessage", "User created successfully!", true);
          e.target.reset();
          userSelectedCategories = [];
          document.querySelectorAll('.cat-chip-user').forEach(chip => {
            chip.style.background = '';
            chip.style.color = '#262626';
          });
          loadUsers();
        } else {
          const error = await res.json();
          showMessage("createUserMessage", error.error || "Failed to create user", false);
        }
      } catch (error) {
        showMessage("createUserMessage", "Error: " + error.message, false);
      }
    };

    document.getElementById("postType").onchange = (e) => {
      const isUserPost = e.target.value === "user";
      document.getElementById("userSelectGroup").classList.toggle("hidden", !isUserPost);
      document.getElementById("authorGroup").classList.toggle("hidden", isUserPost);
      document.getElementById("postUsername").required = isUserPost;
      document.getElementById("postAuthor").required = !isUserPost;
    };

    document.getElementById("createPostForm").onsubmit = async (e) => {
      e.preventDefault();
      try {
        const postType = document.getElementById("postType").value;
        const postData = {
          caption: document.getElementById("postCaption").value,
          image: document.getElementById("postImage").value,
          id: Date.now().toString(),
          categories: postSelectedCategories
        };

        if (postType === "user") {
          postData.username = document.getElementById("postUsername").value;
          if (!postData.username) {
            showMessage("createPostMessage", "Please select a user", false);
            return;
          }
        } else {
          postData.author = document.getElementById("postAuthor").value;
          if (!postData.author) {
            showMessage("createPostMessage", "Please enter an author name", false);
            return;
          }
        }

        const res = await fetch("/api/admin/post", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(postData)
        });

        if (res.ok) {
          showMessage("createPostMessage", "Post created successfully!", true);
          e.target.reset();
          postSelectedCategories = [];
          document.querySelectorAll('.cat-chip-post').forEach(chip => {
            chip.style.background = '';
            chip.style.color = '#262626';
          });
          loadPosts();
        } else {
          const error = await res.json();
          showMessage("createPostMessage", error.error || "Failed to create post", false);
        }
      } catch (error) {
        showMessage("createPostMessage", "Error: " + error.message, false);
      }
    };

    document.getElementById("followForm").onsubmit = async (e) => {
      e.preventDefault();
      const follower = document.getElementById("follower").value;
      const following = document.getElementById("following").value;

      if (follower === following) {
        showMessage("followMessage", "Users cannot follow themselves", false);
        return;
      }

      try {
        const res = await fetch("/api/admin/follow", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ follower, following })
        });

        if (res.ok) {
          showMessage("followMessage", "Follow relationship created!", true);
          e.target.reset();
          loadFollows();
        } else {
          const error = await res.json();
          showMessage("followMessage", error.error || "Failed to create follow", false);
        }
      } catch (error) {
        showMessage("followMessage", "Error: " + error.message, false);
      }
    };

    document.getElementById("likeUsername").onchange = async (e) => {
      const postSelect = document.getElementById("likePostSelect");
      
      if (!e.target.value) {
        postSelect.disabled = true;
        postSelect.innerHTML = '<option value="">First select a user...</option>';
        return;
      }

      try {
        const res = await fetch("/api/admin/posts");
        const posts = await res.json();
        
        if (posts.length === 0) {
          postSelect.innerHTML = '<option value="">No posts available</option>';
          postSelect.disabled = true;
          return;
        }

        postSelect.disabled = false;
        postSelect.innerHTML = '<option value="">Select a post...</option>' + 
          posts.map(post => {
            const owner = post.username ? `@${post.username}` : `@${post.exploreAuthor}`;
            const truncated = post.caption.length > 60 
              ? post.caption.substring(0, 60) + '...' 
              : post.caption;
            return `<option value="${post.id}">[${owner}] ${truncated}</option>`;
          }).join("");
      } catch (error) {
        console.error("Error loading posts:", error);
      }
    };

    document.getElementById("likeForm").onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById("likeUsername").value;
      const postId = document.getElementById("likePostSelect").value;
      
      if (!postId) {
        showMessage("likeMessage", "Please select a post", false);
        return;
      }

      try {
        const res = await fetch("/api/admin/like", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, postId })
        });

        if (res.ok) {
          showMessage("likeMessage", "Like created successfully!", true);
          document.getElementById("likePostSelect").disabled = true;
          document.getElementById("likePostSelect").innerHTML = '<option value="">First select a user...</option>';
          document.getElementById("likeUsername").value = "";
          loadLikes();
        } else {
          const error = await res.json();
          showMessage("likeMessage", error.error || "Failed to create like", false);
        }
      } catch (error) {
        showMessage("likeMessage", "Error: " + error.message, false);
      }
    };

    // ==================== DELETE HANDLERS ====================

    async function deleteUser(username) {
      if (!confirm(`Delete user @${username}? This will also delete all their posts and relationships.`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/user/${username}`, { method: "DELETE" });
        if (res.ok) {
          loadUsers();
          loadPosts();
          loadFollows();
          loadLikes();
        } else {
          alert("Failed to delete user");
        }
      } catch (error) {
        alert("Error: " + error.message);
      }
    }

    async function deletePost(postId) {
      if (!confirm(`Delete this post? This will also delete all likes on it.`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/post/${postId}`, { method: "DELETE" });
        if (res.ok) {
          loadPosts();
          loadLikes();
        } else {
          alert("Failed to delete post");
        }
      } catch (error) {
        alert("Error: " + error.message);
      }
    }

    // ==================== INITIALIZE ====================
    loadCategories();
    loadUsers();
    loadPosts();
    loadFollows();
    loadLikes();
  </script>
</body>
</html>